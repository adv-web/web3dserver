<!DOCTYPE html>
<html>
  <head>
  <meta charset='UTF-8'>
  <title>CoffeeScript API Documentation</title>
  <script src='../javascript/application.js'></script>
  <script src='../javascript/search.js'></script>
  <link rel='stylesheet' href='../stylesheets/application.css' type='text/css'>
</head>
  <body>
    <div id='base' data-path='../'></div>
<div id='header'>
  <div id='menu'>
    <a href='../extra/README.md.html' title='Web3dserver'>
      Web3dserver
    </a>
    &raquo;
    <a href='../alphabetical_index.html' title='Index'>
      Index
    </a>
    &raquo;
    <span class='title'>README.md</span>
  </div>
</div>
    <div id='content'>
      <nav class='toc'>
        <p class='title'>
          <a class='hide_toc' href='#'>
            <strong>Table of Contents</strong>
          </a>
          <small>
            (<a class='float_toc' href='#'>left</a>)
          </small>
        </p>
      </nav>
      <div id='filecontents'>
        <h1 id="-">服务器说明文档</h1>
<h2 id="1-">1 环境配置</h2>
<h3 id="1-1-">1.1  开发环境</h3>
<ol>
<li>IDE：<a href="https://www.jetbrains.com/webstorm/">Webstorm</a></li>
<li>开发语言：<a href="http://coffee-script.org/">CoffeScript</a></li>
</ol>
<h3 id="1-2-">1. 2 运行环境</h3>
<ol>
<li>运行平台：<a href="https://nodejs.org/en/">NodeJS</a></li>
<li>数据库：<a href="https://www.mysql.com/">Mysql</a></li>
</ol>
<h3 id="1-3-">1.3 运行方法</h3>
<ol>
<li><p>安装nodejs和mysql。</p></li>
<li><p>新建数据库，参考schema.sql文件。</p></li>
<li><p>在src/ExpressServer.coffee文件中修该数据库地址：</p><pre><code class="lang-coffeescript">  # init a express server.
  # init database connector.
  # init other services.
  # @param [Express] app Express app.
  constructor: (@app) -&gt;
    # create database connection
    @app.use(orm.express(&quot;mysql://root:123456@localhost:3306/web3d&quot;, { # here
      # register models
      define: (db, models, next) =&gt;
        models.User = User.instance?(db)
        next()
    }))
</code></pre>
</li>
<li><p>安装依赖库</p><p>在项目目录下执行: npm install</p></li>
<li><p>运行</p><p>在项目目录下执行: npm start</p></li>
</ol>
<h3 id="1-4-">1.4 主要依赖库</h3>
<ol>
<li><a href="http://www.expressjs.com.cn/4x/api.html">Express</a>: 一个简单、轻量、可靠的web框架</li>
<li><a href="https://socket.io/docs/">scoket.io</a>: 一个简单、鲁棒的对websocket进行封装的库，同时当客户端不支持websocket时，内部也会以http请求模拟实现。</li>
<li><a href="https://github.com/dresende/node-orm2">orm2</a>：简单易用的orm框架，鲁棒性不是很好，其开发者提倡使用指定版本的mysql库。</li>
<li><p><a href="http://coffee-script.org/">coffee-script</a>: 对面向对象有很好实现的基于js的语言，简单易学。</p><h2 id="2-">2 项目结构和文件说明</h2>
</li>
</ol>
<h3 id="2-1-">2.1 项目结构</h3><p><img src="docs/img/dir.PNG" alt="项目结构"></p><ol>
<li><p>domain, service 和 ExpressServer.coffee主要实现用户登录注册、保存用户信息的功能。</p></li>
<li><p>game实现了多人游戏的服务端，主要包含</p><p>GameServer.coffee: 处理创建，销毁游戏；玩家加入，离开游戏的请求。</p><p>GameManager.coffee：管理一局游戏内部各种信息同步工作。</p><p>Component/：扩展游戏功能。可在GameServer创建游戏的时候，选择在游戏中加入哪些组件。</p><p>ChatServer.coffee: 实现多人聊天的服务器端，该服务与游戏服务独立开来。之后会考虑将该服务写成组件。</p></li>
<li><p>app.coffee: 项目启动文件。</p></li>
<li><p>其它：无关文件（可删除），考虑以后可能添加功能，故保留这个完整的express项目结构。</p></li>
</ol>
<h3 id="2-2-">2.2 文件说明及方法说明</h3>
<ol>
<li>每个文件的具体说明，请参考<a href="https://adv-web.github.io/web3dserver/doc/">https://adv-web.github.io/web3dserver/doc/</a></li>
</ol>
<h2 id="3-">3 主要功能实现说明</h2>
<ol>
<li><p>GameServer</p><p>这个类会处理创建游戏，加入游戏，销毁游戏的请求。并且维护现在的游戏数目信息。该类利用socket.io实现非常简单。</p></li>
<li><p>GameManager</p><p>管理一局游戏内部各种信息同步工作。当GameServer创建一个游戏的时候，服务器就会创建一个GameManager来管理这局游戏的信息同步工作。</p><p>该类定义三个与客户端交流的事件：创建gameObject，更新gameObject的信息，删除gameObject。维护一个游戏的生命周期：现在只有初始化、游戏开始、游戏结束三个状态点。</p><p>该类维护该局游戏所加载的所有组件，并在游戏生命周期的状态点对他们进行调用。</p><pre><code class="lang-coffeescript">    # It will be too complicated to do all this work in this class
  # this function to let you use a component to listen to message and handle the message
  #
  # @param [NetWorkComponent] the component to listen to message and handle the message
  registerComponent: (comp) =&gt;
    @comps.push(comp) # register this component
    comp.onRegister?(@)

  # start the game
  #
  # this method will inform all clients to start game
  startGame: () =&gt;
    for id, p of @players
      p.send(&#39;s.s&#39;)

    # start game
    for comp in @comps
      comp.onStartGame?(@)

    @started = true

  # end the game
  #
  # this method will inform all clients to end game
  endGame: () =&gt;
    # inform all clients
    for id, p of @players
      p.send(&#39;s.e&#39;)

    # end game
    for comp in @comps
      comp.onEndGame?(@)
</code></pre><p>​</p></li>
<li><p>Component</p><p>Component利用GameManager提供生命周期状态点扩展游戏功能。他们都继承自NetworkComponent：</p><pre><code class="lang-coffeescript"># Base class which should be inherited by scripts which
# contain networking functionality on the server
#
class NetWorkComponent
  module.exports = this

  # @param [String] name the name of this component
  constructor: (@name) -&gt;

  # It will be called when you register this component.
  # You can register this component to the game manager through manager.register(comp)
  # @param [GameManager] manager the manager of this game
  onRegister: (manager) =&gt;

  # It will be called when the game started by the game manager.
  # You can register this component to the game manager through manager.register(comp)
  # @param [GameManager] manager the manager of this game
  onStartGame: (manager)=&gt;

  # It will be called when the game is end.
  # You can register this component to the game manager through manager.register(comp)
  # @param [GameManager] manager the manager of this game
  onEndGame: (manager) =&gt;
</code></pre><p>现在组件提供这三个状态点扩展功能。</p><p>例如现有的TreeLoader组件在游戏开始时决定在场景中生成一些树，GameTimeInformer会在每秒通知客户端游戏进行的时间。NetWorkTransform组件会通知各个玩家其它玩家的位置信息。</p><p>然后GameServer创建游戏的时候可以决定使用哪些组件，如下代码：就装配了一个会同步玩家位置，有游戏计时的游戏。</p><pre><code class="lang-coffeescript">    # load the component that automatically synchronize the transform if this player
    game.registerComponent(new NetWorkTransform(player))
    # load game time informer
    game.registerComponent(new GameTimeInformer())
</code></pre><p>以此种方法就可以创建类型多样的游戏，玩家可以定制游戏中的一些会发生的事件。</p></li>
</ol>
<h2 id="related-docs">Related Docs</h2>
<ol>
<li><a href="https://adv-web.github.io/web3dserver/doc/">项目文档</a></li>
<li><a href="./docs/design.md.html">Design Daft</a></li>
<li><a href="./docs/api_doc.md.html">API DOC</a>: how to use apis like login, register and so on.</li>
</ol>

      </div>
    </div>
    <div id='footer'>
  By
  <a href='https://github.com/coffeedoc/codo' title='CoffeeScript API documentation generator'>
    Codo
  </a>
  2.1.2
  &#10034;
  Press H to see the keyboard shortcuts
  &#10034;
  <a href='http://twitter.com/netzpirat' target='_parent'>@netzpirat</a>
  &#10034;
  <a href='http://twitter.com/_inossidabile' target='_parent'>@_inossidabile</a>
</div>
<iframe id='search_frame'></iframe>
<div id='fuzzySearch'>
  <input type='text'>
  <ol></ol>
</div>
<div id='help'>
  <p>
    Quickly fuzzy find classes, mixins, methods, file:
  </p>
  <ul>
    <li>
      <span>T</span>
      Open fuzzy finder dialog
    </li>
  </ul>
  <p>
    Control the navigation frame:
  </p>
  <ul>
    <li>
      <span>L</span>
      Toggle list view
    </li>
    <li>
      <span>C</span>
      Show class list
    </li>
    <li>
      <span>I</span>
      Show mixin list
    </li>
    <li>
      <span>F</span>
      Show file list
    </li>
    <li>
      <span>M</span>
      Show method list
    </li>
    <li>
      <span>E</span>
      Show extras list
    </li>
  </ul>
  <p>
    You can focus and blur the search input:
  </p>
  <ul>
    <li>
      <span>S</span>
      Focus search input
    </li>
    <li>
      <span>Esc</span>
      Blur search input
    </li>
  </ul>
</div>
  </body>
</html>